<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Table from CSV</title>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.6.2/css/colReorder.dataTables.min.css">
    <link rel="stylesheet" href="css/styles.css">

</head>
<body>


<div class="controls">
    <div class="controls-header">
        <h2 class="controls-title">Game Data Viewer</h2>
        <div class="btn-group">
            <button id="themeToggleButton" class="btn btn-secondary" title="Toggle between light and dark theme">ğŸŒ™ Dark</button>
            <button id="resetFiltersButton" class="btn btn-secondary" title="Reset all filters and sorting to their default state">ğŸ”„ Reset Filters</button>
            <button id="searchButton" class="btn" title="Search the data">ğŸ”„ Search</button>
        </div>
    </div>



</div>


<table id="csvTable" class="display"></table>

<div id="loadingOverlayElement">
    <div id="loadingHeaderDisplay">Loading Data...</div>
    <div class="spinner"></div>
    <div id="loadingProgressDisplayContainer">
        <div id="loadingProgressBarDisplay"></div>
        <span id="loadingProgressTextDisplay">0%</span>
    </div>
    <button id="stopLoadingButton">â¹ Stop</button>
</div>
</div>




<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/colreorder/1.6.2/js/dataTables.colReorder.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>




<script src="js/utils.js"></script>



<script>

const csvTableElement = $('#csvTable');
const themeToggleButton = document.getElementById('themeToggleButton');
const resetFiltersButton = document.getElementById('resetFiltersButton')
const searchButton = document.getElementById('searchButton')
const stopLoadingButton = document.getElementById('stopLoadingButton')
const loadingOverlayElement = document.getElementById('loadingOverlayElement');
const loadingHeader = document.getElementById('loadingHeaderDisplay');
const loadingProgressBar = document.getElementById('loadingProgressBarDisplay');
const loadingProgressText = document.getElementById('loadingProgressTextDisplay');

let activeCsvFile = null;
let activeColumnDetails = {};


function getActiveCsvFile() {
    return activeCsvFile;
}

function setActiveCsvFile(file) {
    activeCsvFile = file;
}

function getActiveColumnDetails() {
    return activeColumnDetails;
}

function hasValidColumnDetails() {
    return activeColumnDetails && Object.keys(activeColumnDetails).length > 0
}

function updateColumnDetails(columnDetails, fileName, description) {
    activeColumnDetails = columnDetails;
}

async function loadDefaultCsv() {
    if(getActiveCsvFile()){
        return; // already loaded
    }
    const response = await fetch('data/game_data.csv');
    if (!response.ok) {
        alert('Failed to load default CSV');
        return;
    }

    const blob = await response.blob();
    const file = new File([blob], 'game_data.csv', { type: 'text/csv' });

    setActiveCsvFile(file);
}

async function loadDefaultColumnDetailsJson() {
    if(hasValidColumnDetails()){
        return; // already loaded
    }
    const response = await fetch('data/game_column_details.json');
    if (!response.ok) {
        alert('Failed to load default column details');
        return;
    }
    const columnDetails = await response.json();
    updateColumnDetails(columnDetails, 'game_column_details.json', 'Loaded from data/game_column_details.json');
}

</script>



<script src="js/loading.js"></script>
<script src="js/csv-handler.js"></script>
<script src="js/datatable.js"></script>
<script src="js/prefilter.js"></script>



<script>

// Search button
searchButton.addEventListener('click', async () => {
    if (!getActiveCsvFile()) return alert('No CSV file loaded yet.');
    if (!hasValidColumnDetails()) return alert('No column details json loaded yet.');
    await executeCsvSearchWithRetries();
});

// Reset filters button
resetFiltersButton.addEventListener('click', () => {
    if (!$.fn.DataTable.isDataTable(csvTableElement)) return;

    const dt = csvTableElement.DataTable();

    // Reset column searches
    dt.columns().every(function() {
        this.search('');
    });

    // Reset checkboxes
    $('.filter-box input[type="checkbox"]').prop('checked', true);

    // Reset text inputs
    $('.filter-text').val('');

    // Reset column order
    if (dt.colReorder) dt.colReorder.reset();

    // Reset sorting
    dt.order([]).draw(); // only one redraw here
});

// Theme toggle button
themeToggleButton.addEventListener('click', () => {
    document.body.classList.toggle('light-theme');
    const isLight = document.body.classList.contains('light-theme');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    updateThemeButton();
});

// Stop loading button
stopLoadingButton.addEventListener('click', () => {
    cancelLoading();
    hideLoading();
});

</script>







<script>

function loadAndUpdateTheme() {
    // Load saved theme
    if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-theme');
    }
    updateThemeButton()
}

function updateThemeButton() {
    const isLight = document.body.classList.contains('light-theme');
    themeToggleButton.textContent = isLight ? 'ğŸŒ Light' : 'ğŸŒ™ Dark';
}

async function initialize() {
    loadAndUpdateTheme();
}

async function initializeWebsite() {
    await loadDefaultCsv();
    await loadDefaultColumnDetailsJson();
    await executeCsvSearchWithRetries();
}

</script>



<script>
initialize()
</script>



<!-- Code injected for standalone web deployment -->
<script>
initializeWebsite();
</script>



<!--
<script>
initializeWebsite();
</script>
-->


</body>
</html>
